#!/usr/bin/env bash

ZERO=0;

echo "/woke/.githooks/pre-commit executing..."

function check_last_command()
{
    if [ $? -gt $ZERO ];
    then
        exit 1;
    fi
}

pyfiles=()
IFS=$'\n'
for f in $(git diff --cached --name-only --diff-filter=ACMR)
do
    if [[ "$f" == *.py ]]; then
        pyfiles+=("$f")
    fi
done

if [ ${#pyfiles[@]} -ne 0 ]; then
    echo "running \`black ${pyfiles[@]}\`"
    black woke;
    check_last_command;
fi

echo "running \`pytest woke\`"
pytest woke;
check_last_command;

if [ ${#pyfiles[@]} -ne 0 ]; then
    echo "running \`pyright ${pyfiles[@]}\`"
    pyright "${pyfiles[@]}";
    check_last_command;
fi

echo "/woke/.githooks/pre-commit successfully executed."